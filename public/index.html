<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@3.1.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@3.1.0/dist/assets/bpmn-font/css/bpmn.css">

    <link rel="stylesheet" href="./groups.css" />
    <link rel="stylesheet" href="./tabs.css" />
    <link rel="stylesheet" href="./properties.css" />
    <link rel="stylesheet" href="./listeners.css" />
    <link rel="stylesheet" href="./header.css" />

    <style>
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: 900;
            src: url('../fonts/eot/IRANSansWeb_Black.eot');
            src: url('../fonts/eot/IRANSansWeb_Black.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb_Black.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb_Black.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb_Black.ttf') format('truetype');
        }
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: bold;
            src: url('../fonts/eot/IRANSansWeb_Bold.eot');
            src: url('../fonts/eot/IRANSansWeb_Bold.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb_Bold.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb_Bold.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb_Bold.ttf') format('truetype');
        }
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: 500;
            src: url('../fonts/eot/IRANSansWeb_Medium.eot');
            src: url('../fonts/eot/IRANSansWeb_Medium.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb_Medium.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb_Medium.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb_Medium.ttf') format('truetype');
        }
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: 300;
            src: url('../fonts/eot/IRANSansWeb_Light.eot');
            src: url('../fonts/eot/IRANSansWeb_Light.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb_Light.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb_Light.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb_Light.ttf') format('truetype');
        }
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: 200;
            src: url('../fonts/eot/IRANSansWeb_UltraLight.eot');
            src: url('../fonts/eot/IRANSansWeb_UltraLight.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb_UltraLight.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb_UltraLight.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb_UltraLight.ttf') format('truetype');
        }
        @font-face {
            font-family: IRANSans;
            font-style: normal;
            font-weight: normal;
            src: url('../fonts/eot/IRANSansWeb.eot');
            src: url('../fonts/eot/IRANSansWeb.eot?#iefix') format('embedded-opentype'),  /* IE6-8 */
            url('../fonts/woff2/IRANSansWeb.woff2') format('woff2'),  /* FF39+,Chrome36+, Opera24+*/
            url('../fonts/woff/IRANSansWeb.woff') format('woff'),  /* FF3.6+, IE9, Chrome6+, Saf5.1+*/
            url('../fonts/ttf/IRANSansWeb.ttf') format('truetype');
        }

    </style>

    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>

    <style>

        .bpp-properties-entry {
            direction: rtl;
        }

        .djs-direct-editing-parent {
            display: none;
        }

        .hidden {
            display: none;
        }

        .djs-palette {
            max-width: 50px;
            overflow: auto;
        }
        svg {
            margin-left: 100px;
        }
        .popup {
            z-index: 1000001;
            position: absolute;
            top: 30%;
            height: 40%;
            width: 40%;
            left: 30%;
            background-color: #e2e2e2;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);

            color: white;
            display: none;
        }
        .select2-container {
            width: 100% !important;
        }

        .select2-results {
            z-index: 10000001 !important;
        }

        .select2-dropdown, .select2-dropdown--below {
            z-index: 10000001 !important;
        }

        .dark {
            background-color: rgba(217, 219, 222, 0.18);
            z-index: 10001;
            height: 200vh;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }

        .select2-results__option {
            text-align: right;
            direction: rtl;
        }

    </style>

</head>

<body style="font-family: IRANSans !important;">

    <div class="dark hidden"></div>

    <div>

        <div style="width: 80%; float: left">
            <div id="canvas"></div>
        </div>

        <div style="width: 20%; float: left">
            <div id="js-properties-panel"></div>
        </div>
    </div>

    <div>
        <button style="margin-top: 20px" class="btn btn-primary" id="saveBtn">ذخیره</button>
    </div>

    <!--<div>-->
        <!--<div style="width: 80%; float: left">-->
            <!--<div id="canvas2"></div>-->
        <!--</div>-->
        <!--<div style="width: 20%; float: left">-->
            <!--<div id="js-properties-panel2"></div>-->
        <!--</div>-->
    <!--</div>-->

    <div class="popup" id="taskPopup">
        <div class="djs-palette open" style="width: 300px; max-width: 300px; touch-action: none; user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
            <div class="djs-palette-entries">
                <div class="group" data-group="tools">
                    <div id="lozi" data-clicked="0" style="float: none; height: 80px" class="entry bpmn-icon-gateway-none" draggable="true" data-text="lozi" data-action="create.task" title="Create Task">
                        لوزی
                    </div>

                    <div id="rectangle" data-clicked="0" style="float: none; height: 80px" class="entry bpmn-icon-gateway-none" draggable="true" data-text="mostatil" data-action="create.task" title="Create Task">
            مستطیل
                    </div>

                    <div id="ring" data-clicked="0" style="float: none; height: 80px" class="entry bpmn-icon-gateway-none" draggable="true" data-text="dayere" data-action="create.task" title="Create Task">
            دایره
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup" id="selectPopup">

        <div style="min-width: 200px; margin: 20px auto; width: 100%; text-align: center; direction: rtl">
            <select onchange='selectItem()' style="text-align: right; direction: rtl" class="js-example-basic-single" id="select"></select>
        </div>

        <div id="items" class="row" style="padding: 20px; margin-top: 20px; height: 50px"></div>

        <div style="margin: 20px auto; width: fit-content;">
            <button id="done" class="btn btn-success" onclick="done()">تایید</button>
            <button class="btn btn-danger" onclick="$('#selectPopup').css('display', 'none'); $('.dark').addClass('hidden')">لغو</button>
        </div>
    </div>

    <script src="./app.bundled.js"></script>

    <script>

        var selectedItems = [];
        var options = [];
        var mainSelectedId = -1;

        function changeTab(tabId) {

            $(".bpp-properties-group").each(function () {
                if($(this).attr('data-tab-id') == tabId)
                    $(this).removeClass('hidden');
                else
                    $(this).addClass('hidden');
            });
        }

        function fetchData(id, vals) {

            var idx = -1;

            for(var t = 0; t < selectedItems.length; t++) {
                if(selectedItems[t].elem == id) {
                    idx = t;
                    break;
                }
            }

            if(idx == -1)
                return;

            var counter = 0;
            var items = [];

            for(i = 0; i < options.length; i++) {

                if(options[i].id == id) {

                    for(var j = 0; j < vals.length; j++) {
                        for(var k = 0; k < options[i].items.length; k++) {
                            if(options[i].items[k].id == vals[j]) {
                                items[counter++] = options[i].items[k];
                                break;
                            }
                        }
                    }

                    selectedItems[idx].items = items;
                    showAllDoneItems(idx);
                    return;
                }
            }

//            var url = 'http://bp.vcu.ir/getOptions.php';
            var url = 'http://localhost/bp/getOptions.php';

            $.ajax({
                type: 'post',
                url: url,
                data: {
                    'kind': id
                },
                success: function (response) {

                    response = JSON.parse(response);
                    items = [];

                    for(var i = 0; i < response.length; i++) {
                        items[i] = {"name": response[i].name, 'id': response[i].value};
                    }

                    var size = options.length;
                    options[size] = {'id': id, 'items': items};

                    var counter = 0;
                    var items = [];

                    for (var j = 0; j < vals.length; j++) {
                        for (var k = 0; k < options[size].items.length; k++) {
                            if (options[size].items[k].id == vals[j]) {
                                items[counter++] = options[size].items[k];
                                break;
                            }
                        }
                    }

                    selectedItems[idx].items = items;
                    showAllDoneItems(idx);
                }
            });

        }

        function showPopupSelect(id) {

            mainSelectedId = id;
            $(".selectedItemClass").remove();

            var newElement = "<option value='-1'>مسئول مورد نظر خود را انتخاب نمایید</option>";

            for(var i = 0; i < items.length; i++) {
                newElement += "<option value='" + items[i].id + "'>" + items[i].name + "</option>";
            }


            var selectedItemsElement = "";

            for(i = 0; i < selectedItems.length; i++) {
                selectedItemsElement += "<div class='selectedItemClass btn btn-primary col-xs-3' id='item_" + i + "' style='color: white; float:right; margin: 10px; text-align: center; width: fit-content; border: 1px solid black; border-radius: 6px; padding: 7px;'><span>" + selectedItems[i].name + "</span>";
                selectedItemsElement += "<span class='glyphicon glyphicon-remove' onclick='deleteItem(" + i + ")'></span>";
                selectedItemsElement += "</div>";
            }

            $("#items").empty().append(selectedItemsElement);
            $(".dark").removeClass('hidden');
            $("#select").empty().append(newElement);
            $("#selectPopup").css('display', 'block');
            $('.js-example-basic-single').select2();
        }

        function selectItem() {

            var newVal = $("#select").val();

            if(newVal == -1)
                return;

            var currIdx = -1;

            var allow = true, size = selectedItems.length;

            for(i = 0; i < size; i++) {
                if(selectedItems[i].id == newVal) {
                    currIdx = i;
                    allow = false;
                    break;
                }
            }

            if(allow) {

                for(i = 0; i < items.length; i++) {
                    if(items[i].id == newVal) {
                        selectedItems[size] = items[i];
                        currIdx = size;
                        break;
                    }
                }

                if(currIdx != -1) {
                    var newElement = "<div class='selectedItemClass btn btn-primary col-xs-3' id='item_" + size + "' style='color: white; float:right; margin: 10px; text-align: center; width: fit-content; border: 1px solid black; border-radius: 6px; padding: 7px;'><span>" + selectedItems[currIdx].name + "</span>";
                    newElement += "<span class='glyphicon glyphicon-remove' onclick='deleteItem(" + size + ")'></span>";
                    newElement += "</div>";
                    $("#items").append(newElement);
                }
            }

        }

        function showAllDoneItems(idx) {

            var newElement = "";

            for(i = 0; i < selectedItems[idx].items.length; i++) {
                newElement += "<div class='btn btn-primary col-xs-6' id='item_" + i + "' style='color: white; float:right; margin: 10px; text-align: center; width: fit-content; border: 1px solid black; border-radius: 6px; padding: 7px;'><span>" + selectedItems[idx].items[i].name + "</span>";
                newElement += "<span class='glyphicon glyphicon-remove' onclick='deleteItem(" + i + ")'></span>";
                newElement += "</div>";
            }

            $("#" + selectedItems[idx].elem).empty().append(newElement);

        }

        function done() {

            $(".dark").addClass('hidden');
            $("#selectPopup").css('display', 'none');

            var text = "";
            var first = true;

            for (i = 0; i < selectedItems.length; i++) {
                if(first) {
                    first = false;
                    text += selectedItems[i].id;
                }
                else {
                    text += "-" + selectedItems[i].id;
                }
            }

            $("#" + mainSelectedId).val(text).change().focusout();
            showAllDoneItems();
        }

        function deleteItem(i) {
            selectedItems.splice(i, 1);
            $("#item_" + i).remove();
        }
    </script>

</body>

</html>
